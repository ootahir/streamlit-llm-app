from dotenv import load_dotenv

load_dotenv()
import streamlit as st
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage

# ----------------------------------------
# LLM 初期化
# ----------------------------------------
llm = ChatOpenAI(model_name="gpt-4o-mini", temperature=0)

st.title("専門家切替 LLM チャット")

# ----------------------------------------
# 使い方説明（エキスパンダーで折りたたみ可能）
# ----------------------------------------
with st.expander("📘 このアプリの使い方を見る", expanded=False):
    st.markdown("""
    ## 🎯 このアプリでできること
    
    このWebアプリは、入力した文章をもとに **AI（LLM）から回答を得られるシンプルな対話ツール** です。  
    ラジオボタンで **AIに振る舞わせる専門家の種類** を選択することで、質問内容に応じた **専門視点の回答** を受け取ることができます。
    
    ### 🅰 薬の専門家モード
    - 薬の効果・副作用・飲み合わせ・服薬方法の確認
    - 医療・薬に関する一般的な疑問の整理
    
    ### 🅱 英語教師モード
    - 英文法・英語表現の解説
    - 英作文の添削
    - 発音やニュアンスの説明
    - 例文を使った学習サポート
    
    ---
    
    ## 🛠 操作方法
    
    ### ① 専門家を選ぶ
    ラジオボタンから、**A: 薬の専門家** または **B: 英語教師** を選択します。
    
    ### ② 質問を入力
    テキスト入力フォームに、知りたい内容を入力してください。
    
    **入力例**
    - 「この薬の副作用を教えてください」
    - 「This is と That is の違いを教えてください」
    
    ### ③ 送信する
    「送信」ボタンを押すと、選択した専門家モードにもとづいた AI の回答が表示されます。
    
    ### ④ 回答を確認
    画面下部に **AIからの回答結果** が表示されます。
    
    ---
    
    ## ℹ️ 注意事項
    
    - 医療関連の回答は**一般的な情報提供を目的としています**。  
      診断・処方の最終判断は、必ず医師または薬剤師にご相談ください。
    - 本アプリで入力された内容は学習目的で保存されることはありません。
    
    ---
    
    ## ✅ 使い方のポイント
    
    - 専門家モードは**いつでも切り替え可能**です。
    - 同じ質問を異なる専門家モードで聞くことで、**知識の見え方の違いを比較できます。**
    - 学習の確認や日常の調べものに気軽にご利用ください。
    """)

st.divider()

# ----------------------------------------
# 専門家選択ラジオボタン
# ----------------------------------------
expert_choice = st.radio(
    "LLMに回答させる専門家を選択してください",
    options=("A: 薬の専門家", "B: 英語教師")
)

# ラジオボタンの選択値から SystemMessage を作成
if expert_choice.startswith("A"):
    system_prompt = (
        "あなたは薬の専門家（薬剤師）として振る舞います。"
        "薬の作用、副作用、相互作用、服薬方法などについて、"
        "安全に配慮しながら、分かりやすく専門的に説明してください。"
    )
else:
    system_prompt = (
        "あなたは英語教師として振る舞います。"
        "英文法、語彙、表現のニュアンスを、日本語を交えて"
        "分かりやすく説明し、必要に応じて例文を示してください。"
    )

# ----------------------------------------
# 入力フォーム（1つ）
# ----------------------------------------
user_input = st.text_area(
    "質問を入力してください",
    height=120,
    placeholder="例: 日本の首都を教えてください。"
)

# ----------------------------------------
# 送信処理
# ----------------------------------------
if st.button("送信"):
    if not user_input.strip():
        st.warning("テキストを入力してください。")
    else:
        try:
            # LangChain メッセージ構築（ご提示サンプルを踏襲）
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_input),
            ]

            # LLM 実行
            with st.spinner("回答を生成中..."):
                result = llm.invoke(messages)

            # 結果表示
            st.markdown("## 回答")
            st.write(result.content)
        
        except Exception as e:
            st.error(f"エラーが発生しました: {str(e)}")
            st.info("APIキーが正しく設定されているか、.envファイルを確認してください。")
